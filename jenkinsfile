node {
    stage('Build') {
        git changelog: false, poll: false, url: 'https://github.com/erasmussen39/tomcat-hello-world.git', branch: 'scripted'
        sh 'mvn clean package'
    }

    stage('Deploy') {
        stage('Deploy Server 1') {
            sh('''DEPLOY_RESULT=$(curl -o /dev/null --silent --head --write-out \'%{http_code}\\n\' -u ${TOMCAT_SERVER_1_USER}:${TOMCAT_SERVER_1_PASS} \"http://${TOMCAT_SERVER_1}:${TOMCAT_SERVER_1_PORT}/manager/text/deploy?path=/${TOMCAT_APP_NAME}&war=file:${WORKSPACE}/target/${TOMCAT_APP_NAME}.war\")
            echo "DEPLOY_RESULT: ${DEPLOY_RESULT}"
            if [ ${DEPLOY_RESULT} -ne 200 ]
            then
                exit 1
            else
                exit 0
            fi''')
        }
        
        stage('Deploy Server 2') {
            sh('''DEPLOY_RESULT=$(curl -o /dev/null --silent --head --write-out \'%{http_code}\\n\' -u ${TOMCAT_SERVER_2_USER}:${TOMCAT_SERVER_2_PASS} \"http://${TOMCAT_SERVER_2}:${TOMCAT_SERVER_2_PORT}/manager/text/deploy?path=/${TOMCAT_APP_NAME}&war=file:${WORKSPACE}/target/${TOMCAT_APP_NAME}.war\")
            echo "DEPLOY_RESULT: ${DEPLOY_RESULT}"
            if [ ${DEPLOY_RESULT} -ne 200 ]
            then
                exit 1
            else
                exit 0
            fi''')
        }
    }

    stage('Teardown Server 1') {
        sh('''UNDEPLOY_RESULT=$(curl -o /dev/null --silent --head --write-out \'%{http_code}\\n\' -u ${TOMCAT_SERVER_1_USER}:${TOMCAT_SERVER_1_PASS} \"http://${TOMCAT_SERVER_1}:${TOMCAT_SERVER_1_PORT}/manager/text/undeploy?path=/${TOMCAT_APP_NAME}\")
        echo "UNDEPLOY_RESULT: ${UNDEPLOY_RESULT}"
        if [ ${UNDEPLOY_RESULT} -ne 200 ]
        then
            exit 1
        fi''')
        deleteDir()
    }

    stage('Teardown Server 2') {
        sh('''UNDEPLOY_RESULT=$(curl -o /dev/null --silent --head --write-out \'%{http_code}\\n\' -u ${TOMCAT_SERVER_2_USER}:${TOMCAT_SERVER_2_PASS} \"http://${TOMCAT_SERVER_2}:${TOMCAT_SERVER_2_PORT}/manager/text/undeploy?path=/${TOMCAT_APP_NAME}\")
        echo "UNDEPLOY_RESULT: ${UNDEPLOY_RESULT}"
        if [ ${UNDEPLOY_RESULT} -ne 200 ]
        then
            exit 1
        fi''')
        deleteDir()
    }

}
